
#Variables Start

$ErrorActionPreference = 'SilentlyContinue'
$ProgressPreference = 'SilentlyContinue'

$ScriptName       = 'RTDiagnostic'
$ScriptVers       = '0.1'

$DirBse = $Env:SystemDrive+'\RTSupport'    # Base working Directory

$LogName = ((Get-Date -UFormat "%Y.%m.%d_%R") -replace '[:]')+'_'+$env:COMPUTERNAME+'_'+$ScriptNme+'_v'+$ScriptVer
    $LogTmp = $DirBse+'\'+$LogName+'.tmp'
    $LogTxt = $DirBse+'\'+$LogName+'.log'

# Pre-Requsite Variables
    $ApprovedOperatingSystems    =    ('Microsoft Windows 10 Home', 'Microsoft Windows 10 Pro', 'Microsoft Windows 11 Home', 'Microsoft Windows 11 Pro')
    $MinimumPowerShellVersion    =    "5.1"

# Variables End

# Functions Start
    # Most functions that don't require security are stored in a Github public repo
    $gURL = 'https://raw.githubusercontent.com/RelayTechIT/RTDiag/main/'
    iwr -useb "$gURL`RTDiagFunctions" | iex
# Functions End

# Begin the script transcript to the logfile
    Start-Transcript $LogTxt

# Script Start

# Check Pre-Requsites
#    iwr -useb 'https://raw.githubusercontent.com/RelayTechIT/RTDiag/main/RTDiag-PreRequsites' | iex

# Check if Admin
$IsAdmin = [bool](([System.Security.Principal.WindowsIdentity]::GetCurrent()).groups -match "S-1-5-32-544")
if (!($IsAdmin)) {
    _ErrorMsg -ErrorMessage  "This script must be run with administrative rights. Log in as an administrator and run again."
}

# Check Powershell version
if ($PSVersionTable.PSVersion.Major -lt $MinimumPowerShellVersion.Split(".")[0]) {
    _ErrorMsg -ErrorMessage "Minimum Powershell version is $($MinimumPowerShellVersion). Update Powershell and run again."
    _ErrorMsg -ErrorMessage $PSVersionTable
}

# Check Operating System
    $Info = Get-ComputerInfo
    $ApprovedOperatingSystems | foreach {If ($_ -match $Info.OSName) {$OSPass++}}
    If (!($OsPass)) {
        _ErrorMsg -ErrorMessage "OS: $($Info.OSName) is not an approved Operating System."
    }

# Launch Menu if no pre-requsite errors
If ($ErrN) {
    iwr -useb 'https://raw.githubusercontent.com/RelayTechIT/RTDiag/main/RTDiag_Menu' | iex
} else {
    _Msg -type "Pass" -message "All prerequsites passed"
}



